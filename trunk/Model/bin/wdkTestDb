#!@perl@

use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use Getopt::Long;
use Carp;

my ($dropDb, $createDb, $modelConfigFile);

&GetOptions ('configFile=s' => \$modelConfigFile,
	     'dropDatabase!' => \$dropDb,
	     'createDatabase!' => \$createDb);

&usage unless $modelConfigFile && ($dropDb || $createDb);

my $GUS_HOME=$ENV{GUS_HOME};

my $javaDir = "$GUS_HOME/lib/java";

opendir(DATADIR, $javaDir) || &confess ("Error:  Could not open $javaDir.  Please check the directory exists and try again.");

my $CLASSPATH = "";

while (my $nextFileName = readdir(DATADIR)){
    if ($nextFileName =~ /.*\.jar$/){
	$CLASSPATH .= "$javaDir/$nextFileName" . ":"
    }
}

my $args = "-configFile $modelConfigFile ";

if ($dropDb){
    $args .= "-dropDatabase ";
}
if ($createDb){
    $args .= "-createDatabase ";
}

my $dataDirectory = "$ENV{GUS_HOME}/data/WDK/ToyModel/testTables/";

opendir(DATADIR, "$dataDirectory") || die ("opendir failed when trying to open $dataDirectory");
my $nextTableName;
my @tables;
while ($nextTableName = readdir(DATADIR)){

    if ($nextTableName =~ /^[A-Za-z]+$/){
	
	push (@tables, $nextTableName);
    }
}

my $tableArg = "";

foreach my $tableName (@tables){
    $tableArg .= $dataDirectory . "/" . $tableName . " ";
}

$args .= "-tables $tableArg";

my $cmd = "java -Djdbc.drivers=oracle.jdbc.driver.OracleDriver -DcmdName=wdkTestDb -classpath $CLASSPATH org.gusdb.wdk.model.test.TestDBManager $args";

#print STDERR "wdkTestDb: running command $cmd\n";

system($cmd);

############

sub usage {
    print "\nusage:  parses flat files representing database tables and inserts them into the database. \n\nwdkTestDb\n \t-configFile (database configuration file to use with wdk model)\n\t<-dropDatabase|-createDatabase> (action to take with database; dropping when non-existent or creating when already existing will do nothing; include both to reset database)\n\n";
    exit(1);
}
