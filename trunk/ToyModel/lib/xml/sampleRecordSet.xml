<?xml version="1.0"?>
 
<wdkModel> name="RNARecords">

<recordSet name="RNARecords">
   <record name="RNARecord" type="DoTS Transcript" idPrefix="DT.">
     <fieldsQuery referent="RNARecordQueries.RNAFields"/>

     <tableQuery referent="RNARecordQueries.ExternalLinks"/>

     <textField name="overview">
       <text>
       This is DoTS Transcript DT.$$primaryKey$$.  It is has a length of $$length$$.
       </text>
     </textField>
   </record>

</recordSet>

<recordListSet name="RNARecordLists">

   <recordList name="RNARecordList"
               recordRef="RNARecords.RNARecord"
               queryRef="RNARecordQueries.RNAIdsByGoId" />
</recordListSet>

<querySet name="RNARecordQueries">

   <sqlQuery name="RNAIdsByGoId">

      <stringParam name="GoId"
                   prompt="GO ID"
                   sample="GO:0016597"
                   regex="\S+"/>
       
      <column name="na_sequence_id" displayName="Assembly ID" />     

      <sql>
        select distinct a.na_sequence_id
        from dots.Assembly a, dots.Protein P,
             dots.GOAssociation ga, sres.GoTerm gt,
             dots.RNAInstance rnai, dots.RNAFeature rnaf
        where rnai.rna_id = p.rna_id
          and rnai.na_feature_id = rnaf.na_feature_id
          and rnaf.na_sequence_id = a.na_sequence_id
          and p.protein_id = ga.row_id
          and ga.table_id = 180
          and ga.go_term_id = gt.go_term_id
          and gt.go_id = '$$GoId$$'
          and gt.external_database_release_id = 7798
          and ga.is_deprecated = 0
       </sql>
   </sqlQuery>

   <sqlQuery name="RNAFields">

     <stringParam name="primaryKey"/>

     <column name="description" displayName="Description" />
     <column name="length" displayName="Length" />
     <column name="assembly_consistency" displayName="Assembly consistency" />
     <column name="contains_mrna" displayName="Contains mRNA" />
     <column name="number_of_contained_sequences" displayName="Number contained sequences" />
     <column name="taxon_name" displayName="Taxon Name" />
     <column name="modification_date" displayName="Last modified" />
     <column name="review_status_name" displayName="Review status" />

     <sql>
       select r.description, 
              a.length, 
              a.assembly_consistency, 
              a.contains_mrna,
              a.number_of_contained_sequences, 
              tn.name as taxon_name, 
              TO_CHAR(a.modification_date, 'Mon DD, YYYY HH:MI:SSAM') as modification_date, 
              rvw.name as review_status_name
      from dots.Assembly a, sres.TaxonName tn, 
           dots.RNAFeature rf, dots.RNAInstance rs, 
           dots.RNA r, sres.ReviewStatus rvw 
      where a.na_sequence_id = $$primaryKey$$ 
        and r.review_status_id = rvw.review_status_id 
        and rf.na_sequence_id = a.na_sequence_id 
        and rf.na_feature_id = rs.na_feature_id 
        and rs.rna_id = r.rna_id 
        and a.taxon_id = tn.taxon_id 
        and tn.name_class = 'scientific name'
     </sql>
  </sqlQuery>

  <sqlQuery name="ExternalLinks">

    <stringParam  name="primaryKey"/>

    <column name="name" displayName="Database" />
    <column name="primary_identifier" displayName="Id" />
    <column name="secondary_identifier" displayName="Locus name" />
    <column name="chromosome" displayName="Chromosome" />
    <column name="centimorgans" displayName="cM" />
    <column name="external_database_release_id" />

    <sql>
      select ed.name,  dbr.primary_identifier, dbr.secondary_identifier, 
             dbr.chromosome, dbr.centimorgans,dbr.external_database_release_id 
      from dots.DBRefNASequence dbrn, sres.DBRef dbr, sres.ExternalDatabase ed,
           sres.ExternalDatabaseRelease edr 
       where dbrn.na_sequence_id = $$primaryKey$$ 
         and dbrn.db_ref_id = dbr.db_ref_id 
         and dbr.external_database_release_id = edr.external_database_release_id 
         and edr.external_database_id = ed.external_database_id
    </sql>
  </sqlQuery>

</querySet>
</wdkModel>

