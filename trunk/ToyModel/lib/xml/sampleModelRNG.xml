<?xml version="1.0"?>
 
<wdkModel name="RnaModel">


  <referenceList name="InterestingRnaSummaries">

     <reference twoPartName="RnaSummaries.RnasByGoId"/>
     <reference twoPartName="RnaSummaries.RnasByGeneCardName"/>

  </referenceList>



  <recordSet name="RnaRecords">

     <record name="RnaRecord" type="DoTS Transcript" idPrefix="DT.">

       <attributeQuery twoPartName="RnaSummaryQueries.RnaSummary"/>  
   
       <attributeQuery twoPartName="RnaRecordQueries.RnaFields"/>
             
       <tableQuery twoPartName="RnaRecordQueries.ExternalLinks"/>
       
       <textField name="overview">
         <text>
       This is DoTS Transcript DT.$$primaryKey$$.  It is has a length of $$length$$.
         </text>
       </textField>
     </record>

     <record name="RnaSummaryRecord" type="DoTS Transcript" idPrefix="DT.">
       <attributeQuery twoPartName="RnaSummaryQueries.RnaSummary"/>  
       <tableQuery twoPartName="RnaRecordQueries.ExternalLinks"/>
     </record>

  </recordSet>



  <summarySet name="RnaSummaries">

     <summary name="RnasByGoId"
              queryRef="RnaIdQueries.ByGoId"
              recordRef="RnaRecords.RnaSummaryRecord"/>

     <summary name="RnasByGeneCardName"
              queryRef="RnaIdQueries.ByGeneCardName"
              recordRef="RnaRecords.RnaSummaryRecord"/>
  
  </summarySet>



  <querySet name="VocabQueries">

    <sqlQuery name="TaxonQuery">
      <column name="term"/>
      <column name="internal"/>
      <sql>
        select distinct name as term, taxon_id as internal
        from SRes.taxonName
        where name in ('mouse', 'human')
      </sql>
    </sqlQuery>
  </querySet>



  <querySet name="RnaRecordQueries">
    
    <sqlQuery name="RnaFields">

       <paramRef twoPartName="params.primaryKey"/>

       <column name="description" displayName="Description" />
       <column name="length" displayName="Length" />
       <column name="assembly_consistency" displayName="Assembly consistency" />
       <column name="contains_mrna" displayName="Contains mRNA" />
       <column name="number_of_contained_sequences" displayName="Number contained sequences" />
       <column name="modification_date" displayName="Last modified" />
       <column name="review_status_name" displayName="Review status" />
       <textColumn name="numseqs" 
               displayName="Nice Num" 
               text="number of contained seqs is $$number_of_contained_sequences$$" />
 
       <sql>
       select r.description, 
              a.length, 
              a.assembly_consistency, 
              a.contains_mrna,
              a.number_of_contained_sequences, 
              TO_CHAR(a.modification_date, 'Mon DD, YYYY HH:MI:SSAM') as modification_date, 
              rvw.name as review_status_name
      from dots.Assembly a, sres.TaxonName tn, 
           dots.RNAFeature rf, dots.RNAInstance rs, 
           dots.RNA r, sres.ReviewStatus rvw 
      where a.na_sequence_id = $$primaryKey$$ 
        and r.review_status_id = rvw.review_status_id 
        and rf.na_sequence_id = a.na_sequence_id 
        and rf.na_feature_id = rs.na_feature_id 
        and rs.rna_id = r.rna_id 
        and a.taxon_id = tn.taxon_id 
        and tn.name_class = 'scientific name'
       </sql>
    </sqlQuery>

    <sqlQuery name="ExternalLinks">

      <paramRef twoPartName="params.primaryKey"/>

      <column name="name" displayName="Database" />
      <column name="primary_identifier" displayName="Id" />
      <column name="secondary_identifier" displayName="Locus name" />
      <column name="chromosome" displayName="Chromosome" />
      <column name="centimorgans" displayName="cM" />
      <column name="external_database_release_id" />

      <sql>
      select ed.name,  dbr.primary_identifier, dbr.secondary_identifier, 
             dbr.chromosome, dbr.centimorgans,dbr.external_database_release_id 
      from dots.DBRefNASequence dbrn, sres.DBRef dbr, sres.ExternalDatabase ed,
           sres.ExternalDatabaseRelease edr 
       where dbrn.na_sequence_id = $$primaryKey$$ 
         and dbrn.db_ref_id = dbr.db_ref_id 
         and dbr.external_database_release_id = edr.external_database_release_id 
         and edr.external_database_id = ed.external_database_id
      </sql>
    </sqlQuery>

  </querySet>



  <querySet name="RnaSummaryQueries">

    <sqlQuery name="RnaSummary"
              displayName="RNAs">

      <paramRef twoPartName="params.primaryKey"/>

      <column name="gene_id"/>
      <column name="taxon_name"/>
      <column name="gene_symbol"/>
      <column name="gene_description"/>
      <column name="na_sequence_id"/>
      <column name="assembly_length"/> 
      <column name="assembly_num_sequences"/>
      <column name="assembly_contains_mrna"/>

      <sql>
      select cd.gene_id, cd.taxon_name, cd.gene_symbol, 
             cd.gene_description, cd.na_sequence_id, cd.assembly_length, 
             cd.assembly_num_sequences, 
              cd.assembly_contains_mrna 
      from allgenes.CentralDogma cd
      where cd.na_sequence_id = $$primaryKey$$
      </sql>
    </sqlQuery>
  </querySet>


  <querySet name="RnaIdQueries">

     <sqlQuery name="ByGeneCardName"
            displayName="Gene Card name">

       <paramRef twoPartName="params.GeneName"/>

       <column name="na_sequence_id" />

       <sql>
       select distinct dbrn.na_sequence_id
       from sres.DBRef dbr, dots.DBRefNASequence dbrn 
       where dbr.lowercase_primary_identifier = '$$GeneName$$'
       and dbr.external_database_release_id = 4892
       and dbr.db_ref_id = dbrn.db_ref_id
       </sql>
    </sqlQuery>


    <sqlQuery name="ByGoId"
           displayName="GO Id">

      <paramRef twoPartName="params.GoId"/>

      <paramRef twoPartName="params.Taxon"/>

      <column name="na_sequence_id"/>

      <sql>
      select distinct cd.na_sequence_id 
        from dots.GOAssociation ga, sres.goTerm gt, allgenes.CentralDogma cd 
        where gt.go_id = '$$GoId$$'
        and ga.go_term_id = gt.go_term_id
        and ga.table_id =  @PROTEIN_TABLE@ 
        and ga.row_id = cd.protein_id 
        and cd.taxon_id = $$Taxon$$ 
        and ga.is_deprecated != 1 
        and ga.is_not != 1 
      </sql>

    </sqlQuery>
  </querySet>

  <paramSet name="params">
    <stringParam
      name="GeneName"
      prompt="Gene Name"
      sample="brca1"/>

    <stringParam 
      name="GoId"
      prompt="GO Id"
      help="You know what it is"
      sample="GO:0005013"
      regex="GO:\d+"/>

    <flatCVParam
      name="Taxon"
      prompt="Organism"
      help="You know what it is"
      multipick="yes"
      queryRef="VocabQueries.TaxonQuery"/>
    
    <stringParam 
      name="primaryKey" />

  </paramSet>

</wdkModel>