<?xml version="1.0" encoding="UTF-8"?>
<wdkModel name="toyModel">

    <!-- ******************* -->
    <!-- model introduction  -->
    <!-- ******************* -->
    <introduction>
        Welcome to WDKToySite, a basic website driven by WebDevKit.
        You are invited to explore this site to find out about the core functionalities of WDK.
        Enjoy the surfing!
    </introduction>

    <!-- ******************* -->
    <!-- model questionSet(s) -->
    <!-- ******************* -->
    
    <!-- a set of questions that return lists of RNAs -->
    <questionSet name="RnaQuestions">
        <!-- list of RNAs returned by the query RnaQueries.ByDbESTLib -->
        <question name="ByDbESTLib" queryRef="RnaQueries.ByDbESTLib" recordClassRef="RnaRecordClasses.RnaRecordClass"/>

        <!-- list of RNAs returned by the qyery RnaQueries.ByNumSeqs -->
        <question name="ByNumSeqs" queryRef="RnaQueries.ByNumSeqs" recordClassRef="RnaRecordClasses.RnaRecordClass"/>
    </questionSet>


    <!-- ****************** -->
    <!-- model recordClassSet(s) -->
    <!-- ****************** -->

    <!-- a set of recordClasses, a list of each of which may be returned by a question -->
    <recordClassSet name="RnaRecordClasses">
        <!-- a RNA recordClass, a list of which may be returned by a RNA question -->
        <recordClass idPrefix="DT." name="RnaRecordClass" type="DoTS Transcript">
            <!-- an attribute query that returns question attributes (one row) for a record -->
            <attributeQuery twoPartName="RnaRecordAttributeQueries.RnaQuestion"/>  
            <!-- an attribute query that returns non-question attributes (one row) for a record -->
            <attributeQuery twoPartName="RnaRecordAttributeQueries.RnaFields"/>
            <!-- a table query that returns a table (0 or more rows) of values associated with a record -->
            <tableQuery twoPartName="RnaRecordTableQueries.ConstituentEsts"/>
            <!-- a text attribute that summarizes a record by interpolating values from attribute query results -->
            <textAttribute name="overview">
                <text>
                    This is DoTS Transcript DT.$$primaryKey$$.  It is from $$taxon_name$$.
                </text>
            </textAttribute>
        </recordClass>
    </recordClassSet>

    <!-- ***************** -->
    <!-- model querySet(s) -->
    <!-- ***************** -->

    <!-- a set of queries (for RnaQuestions) that return list of RNAs  -->
    <querySet name="RnaQueries">
        <!-- list of RNAs by the number of EST libs that contributed sequence tags -->
        <sqlQuery name="ByDbESTLib" displayName="RNAs by number of EST libs">
            <description>
                This is a query that finds RNAs which are from given organism
                and contain ESTs from more than a specified number of libraries.
            </description>
            <paramRef twoPartName="params.NumEstLibs"/>
            <paramRef twoPartName="params.ApiTaxon"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct aseq.assembly_na_sequence_id as na_sequence_id 
                    from WDKTestEst est, WDKTestLibrary lib,
                         WDKTestAssemblySequence aseq, WDKTestAssembly a
                    where lib.library_id = est.library_id 
                    and est.na_sequence_id = aseq.na_sequence_id 
                    and aseq.assembly_na_sequence_id = a.na_sequence_id
                    and aseq.assembly_na_sequence_id is not NULL 
                    and a.taxon_id in ($$ApiTaxon$$)
                    group by aseq.assembly_na_sequence_id 
                    having count (distinct lib.dbest_id) >= $$NumEstLibs$$
                ]]>
            </sql>
        </sqlQuery>

        <!-- list of RNAs by the number of contained EST sequence tags -->
        <sqlQuery name="ByNumSeqs" displayName="RNAs by number of seqs included">
            <description>
                This is a query that finds RNAs which are from given organism
                and contain more than a specified number of ESTs.
            </description>
            <paramRef twoPartName="params.NumSeqs"/>
            <paramRef twoPartName="params.ApiTaxon"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct a.na_sequence_id
                    from WDKTestAssembly a
                    where a.number_of_contained_sequences > $$NumSeqs$$
                    and a.taxon_id in ($$ApiTaxon$$)
                ]]>
            </sql>
        </sqlQuery>        
    </querySet>

    <!-- a set of queries (for RnaRecord attributes) that return one row  -->    
    <querySet name="RnaRecordAttributeQueries">
        <!-- a query that returns question attributes of a RNA record -->
        <sqlQuery displayName="RNA question" name="RnaQuestion">
            <paramRef twoPartName="params.primaryKey"/>
            <column name="rna_id"/>
            <column name="taxon_name"/>
            <column name="gene_symbol"/>
            <sql>
                select 'DT.' || a.na_sequence_id as rna_id,
                       tn.name as taxon_name,
                       'MyFavoriteGene' as gene_symbol 
                from WDKTestAssembly a, WDKTestTaxonName tn
                where a.na_sequence_id = $$primaryKey$$ and a.taxon_id = tn.taxon_id
            </sql>
        </sqlQuery>

        <!-- a query that returns non-question attributes of a RNA record -->
        <sqlQuery name="RnaFields">
            <paramRef twoPartName="params.primaryKey"/>
            <column displayName="Assembly consistency" name="assembly_consistency"/>
            <column displayName="Contains mRNA" name="contains_mrna"/>
            <column displayName="Number contained sequences" name="number_of_contained_sequences"/>
            <textColumn displayName="Nice Num" name="numseqs" text="number of contained seqs is $$number_of_contained_sequences$$"/>
            <sql>
                select a.assembly_consistency, 
                       a.contains_mrna,
                       a.number_of_contained_sequences
                from WDKTestAssembly a, WDKTestTaxonName tn 
                where a.na_sequence_id = $$primaryKey$$ 
                and a.taxon_id = tn.taxon_id 
            </sql>
        </sqlQuery>
    </querySet>

    <!-- a set of queries (for RnaRecordClass) that return a table (0 or more rows)  -->    
    <querySet name="RnaRecordTableQueries">
        <sqlQuery name="ConstituentEsts">
            <paramRef twoPartName="params.primaryKey"/>
                <column displayName="EST Id" name="na_sequence_id"/>
                <column displayName="Assembly Sequence Id" name="assembly_sequence_id"/>
                <column displayName="Sequence Start" name="sequence_start"/>
                <column displayName="Sequence End" name="sequence_end"/>
                <column displayName="Quality Start" name="quality_start"/>
                <column displayName="Quality End" name="quality_end"/>
            <sql>
                select aseq.na_sequence_id, aseq.assembly_sequence_id, aseq.sequence_start,
                       aseq.sequence_end, aseq.quality_start, aseq.quality_end
                from WDKTestAssemblySequence aseq, WDKTestAssembly a
                where a.na_sequence_id = $$primaryKey$$
                and a.na_sequence_id = aseq.assembly_na_sequence_id
            </sql>
        </sqlQuery>
    </querySet>
    
    <!-- a set of queries that return controlled vocabulary terms -->
    <querySet name="VocabQueries">
        <!-- a query that returns a list of Apicomplexon taxons -->
        <sqlQuery name="ApiTaxonQuery">
            <column name="term"/>
            <column name="internal"/>
            <sql>
                select distinct name as term, taxon_id as internal
                from WDKTestTaxonName
                where name in ('Neospora caninum', 'Plasmodium falciparum', 'Eimeria tenella',
                               'Plasmodium yoelii', 'Sarcocystis neurona', 'Toxoplasma gondii')
            </sql>
        </sqlQuery>
    </querySet>

    <!-- a set of parameters used by queries -->
    <paramSet name="params">
        <stringParam name="primaryKey" prompt="Primary Key" help="primary key" />
        <stringParam name="NumSeqs" prompt="Number of Contained Sequences" help="number of seqs" regex="\d+"/>
        <stringParam name="NumEstLibs" prompt="Number of EST Libs" help="number of distinct libs" sample="3"/>
        <flatVocabParam name="ApiTaxon" prompt="Organism" help="Apicomplexon taxons" multipick="yes"
         queryRef="VocabQueries.ApiTaxonQuery"/>
    </paramSet>
</wdkModel>
