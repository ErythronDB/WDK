<?xml version="1.0" encoding="UTF-8"?>
<wdkModel name="WTSModel">

    <!-- model recordSet(s) -->

    <recordSet name="WTSRecords">
        <record idPrefix="DT." name="RnaRecord" type="DoTS Transcript">
            <attributeQuery twoPartName="RnaSummaryQueries.RnaSummary"/>  
            <attributeQuery twoPartName="RnaRecordQueries.RnaFields"/>
            <tableQuery twoPartName="RnaRecordQueries.ExternalLinks"/>
            <textAttribute name="overview">
                <text>
                    This is DoTS Transcript DT.$$primaryKey$$.  It is has a length of $$length$$.
                </text>
            </textAttribute>
        </record>

        <record idPrefix="DT." name="RnaSummaryRecord" type="DoTS Transcript">
            <attributeQuery twoPartName="RnaSummaryQueries.RnaSummary"/>  
            <tableQuery twoPartName="RnaRecordQueries.ExternalLinks"/>
        </record>    
    </recordSet>

    <!-- model summarySet(s) -->
    
    <summarySet name="WTSSummaries">
        <summary name="RnasByDbESTLib" queryRef="WTSRnaSeqQueries.ByDbESTLib" recordRef="WTSRecords.RnaSummaryRecord"/>

        <summary name="RnasByNumSeqs" queryRef="WTSRnaSeqQueries.ByNumSeqs" recordRef="WTSRecords.RnaSummaryRecord"/>

        <summary name="RnasBySeqAccn" queryRef="WTSRnaSeqQueries.BySeqAccn" recordRef="WTSRecords.RnaSummaryRecord"/>

        <summary name="RnasByKeyword" queryRef="WTSRnaAnnotQueries.ByKeyword" recordRef="WTSRecords.RnaSummaryRecord"/>

        <summary name="RnasByProdomKeyword" queryRef="WTSRnaAnnotQueries.ByProdomKeyword" recordRef="WTSRecords.RnaSummaryRecord"/>
    </summarySet>

    <!-- model querySet(s) -->
    
    <querySet name="WTSRnaSeqQueries">
        <sqlQuery name="ByDbESTLib">
            <paramRef twoPartName="params.NumSeqs"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct aseq.assembly_na_sequence_id as na_sequence_id 
                    from dots.EST est, dots.Library lib, dots.AssemblySequence aseq
                    where lib.dbest_id = $$0$$ 
                    and lib.library_id = est.library_id 
                    and est.na_sequence_id = aseq.na_sequence_id 
                    and aseq.assembly_na_sequence_id is not NULL 
                    group by aseq.assembly_na_sequence_id 
                    having count (distinct aseq.na_sequence_id) >= $$1$$
                    and a.taxon_id = 2892
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ByNumSeqs">
            <paramRef twoPartName="params.NumSeqs"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct a.na_sequence_id
                    from WDKTestAssembly a
                    where a.number_of_contained_sequences > $$NumSeqs$$
                    and a.taxon_id = 2892
                ]]>
            </sql>
        </sqlQuery>
        
        <sqlQuery name="BySeqAccn">
            <paramRef twoPartName="params.NumSeqs"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select aseq.assembly_na_sequence_id as na_sequence_id
                    from dots.AssemblySequence aseq, dots.ExternalNASequence ena 
                    where ena.source_id = upper('$$0$$')
                    and ena.na_sequence_id = aseq.na_sequence_id
                    and a.taxon_id = 2892
                ]]>
            </sql>
        </sqlQuery>
    </querySet>
    
    <querySet name="WTSRnaAnnotQueries">
        <sqlQuery displayName="RNAs by keyword in description" name="ByKeyword">
            <paramRef twoPartName="params.Keyword"/>
            <column name="na_sequence_id"/>
            <sql>
                select distinct iwl.target_id as na_sequence_id 
                from dots.IndexWord iw, dots.IndexWordLink iwl, dots.NASequenceImp na 
                where iw.word = lower('$$0$$') 
                and iw.index_word_id = iwl.index_word_id 
                and iwl.target_table_id = 56 
                and iwl.target_id = na.na_sequence_id 
                and na.taxon_id $$1$$
             </sql>
        </sqlQuery>

        <sqlQuery displayName="RNAs by keyword in prodom description" name="ByProdomKeyword">
            <paramRef twoPartName="params.ProdomKeyword"/>
            <paramRef twoPartName="params.ApiTaxon"/>
            <column name="na_sequence_id"/>
            <sql>
                <![CDATA[
                select distinct s.query_id as na_sequence_id 
                from dots.IndexWord iw, dots.IndexWordSimLink iwsl,
                     dots.Similarity s, dots.NASequenceImp na 
                where iw.word = lower('$$0$$')
                and iw.index_word_id = iwsl.index_word_id
                and iwsl.best_similarity_id = s.similarity_id 
                and iwsl.similarity_table_id = $$1$$ 
                and iwsl.best_p_value_exp <= $$2$$ 
                and iwsl.target_table_id = 56 
                and s.query_id = na.na_sequence_id 
                and na.taxon_id $$3$$
                ]]>
            </sql>
        </sqlQuery>
    </querySet>

    <querySet name="RnaRecordQueries">
        <sqlQuery name="RnaFields">
            <paramRef twoPartName="params.primaryKey"/>
            <column displayName="Description" name="description"/>
            <column displayName="Length" name="length"/>
            <column displayName="Assembly consistency" name="assembly_consistency"/>
            <column displayName="Contains mRNA" name="contains_mrna"/>
            <column displayName="Number contained sequences" name="number_of_contained_sequences"/>
            <column displayName="Last modified" name="modification_date"/>
            <column displayName="Review status" name="review_status_name"/>
            <textColumn displayName="Nice Num" name="numseqs" text="number of contained seqs is $$number_of_contained_sequences$$"/>
            <sql>
                select r.description,
                       a.length, 
                       a.assembly_consistency, 
                       a.contains_mrna,
                       a.number_of_contained_sequences, 
                       TO_CHAR(a.modification_date, 'Mon DD, YYYY HH:MI:SSAM') as modification_date, 
                       rvw.name as review_status_name
                from dots.Assembly a, sres.TaxonName tn, 
                       dots.RNAFeature rf, dots.RNAInstance rs,
                       dots.RNA r, sres.ReviewStatus rvw 
                where a.na_sequence_id = $$primaryKey$$ 
                and r.review_status_id = rvw.review_status_id
                and rf.na_sequence_id = a.na_sequence_id 
                and rf.na_feature_id = rs.na_feature_id 
                and rs.rna_id = r.rna_id 
                and a.taxon_id = tn.taxon_id 
                and tn.name_class = 'scientific name'
            </sql>
        </sqlQuery>

        <sqlQuery name="ExternalLinks">
            <paramRef twoPartName="params.primaryKey"/>
                <column displayName="Database" name="name"/>
                <column displayName="Id" name="primary_identifier"/>
                <column displayName="Locus name" name="secondary_identifier"/>
                <column displayName="Chromosome" name="chromosome"/>
                <column displayName="cM" name="centimorgans"/>
                <column name="external_database_release_id"/> 
            <sql>
                select ed.name, dbr.primary_identifier, dbr.secondary_identifier,
                       dbr.chromosome, dbr.centimorgans, dbr.external_database_release_id 
                from dots.DBRefNASequence dbrn, sres.DBRef dbr,
                     sres.ExternalDatabase ed, sres.ExternalDatabaseRelease edr
                where dbrn.na_sequence_id = $$primaryKey$$
                and dbrn.db_ref_id = dbr.db_ref_id
                and dbr.external_database_release_id = edr.external_database_release_id
                and edr.external_database_id = ed.external_database_id
            </sql>
        </sqlQuery>
    </querySet>

    <querySet name="RnaSummaryQueries">
        <sqlQuery displayName="RNAs" name="RnaSummary">
            <paramRef twoPartName="params.primaryKey"/>
            <column name="gene_id"/>
            <column name="taxon_name"/>
            <column name="gene_symbol"/>
            <column name="gene_description"/>
            <column name="na_sequence_id"/>
            <column name="assembly_length"/>
            <column name="assembly_num_sequences"/>
            <column name="assembly_contains_mrna"/>
            <sql>
                select cd.gene_id, cd.taxon_name, cd.gene_symbol, 
                       cd.gene_description, cd.na_sequence_id, cd.assembly_length,
                       cd.assembly_num_sequences, cd.assembly_contains_mrna 
                from allgenes.CentralDogma cd
                where cd.na_sequence_id = $$primaryKey$$
            </sql>
        </sqlQuery>
    </querySet>
    
    <querySet name="VocabQueries">
        <sqlQuery name="MammalTaxonQuery">
            <column name="term"/>
            <column name="internal"/>
            <sql>
                select distinct name as term, taxon_id as internal
                from SRes.taxonName
                where name in ('mouse', 'human')
            </sql>
        </sqlQuery>
        <sqlQuery name="ApiTaxonQuery">
            <column name="term"/>
            <column name="internal"/>
            <sql>
                select distinct name as term, taxon_id as internal
                from SRes.taxonName
                where name in ('Neospora caninum', 'Plasmodium falciparum', 'Eimeria tenella',
                               'Plasmodium yoelii', 'Sarcocystis neurona', 'Toxoplasma gondii')
            </sql>
        </sqlQuery>
    </querySet>

    <paramSet name="params">
        <stringParam name="primaryKey"/>
        <stringParam name="NumSeqs" regex="\d+"/>
	    <stringParam name="GeneName" prompt="Gene Name" sample="brca1"/>
<stringParam name="Keyword" prompt="Keyword" sample="embryonic lethal"/>
        <stringParam name="ProdomKeyword" prompt="Prodom Keyword" sample="protein kinase"/><flatVocabParam help="You know what it is" multipick="yes" name="ApiTaxon" prompt="Organism" queryRef="VocabQueries.ApiTaxonQuery"/></paramSet>
</wdkModel>