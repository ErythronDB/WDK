#!/usr/bin/perl

use lib "$ENV{GUS_HOME}/lib/perl";
use WDK::Model::CommandHelper;
use strict;

my ($serverHome, $serverURL, $deployTempDir) = @ARGV;
if (!($serverHome && $serverURL)) {
  print "\nusage: wdkWebServiceDeploy <serverHome> <serverURL> [deployTempDir]\n\n";
  exit(1);
}
$deployTempDir = "deployTmpDir" unless $deployTempDir;

my $GUS_HOME = $ENV{GUS_HOME};
my $cp = &WDK::Model::CommandHelper::getJavaClasspath($GUS_HOME);

if (-d $deployTempDir) {
  system("rm -rf $deployTempDir/*; mkdir $deployTempDir/classes");
} else {
  system("mkdir -p $deployTempDir/classes");
}

# stage 0
#
print "\nREMINDER: build specific services (eg ApiComplexa/NcbiBlast) before running this deploy command!\n\n";

print "deploying config files ...\n";
my $cmd = "cp -f $GUS_HOME/config/WEB-INF/* $serverHome/WEB-INF/";
system("$cmd"); die ("ERROR: $!\nfailed running $cmd\n\n") if $?;

my $cnfDir = "$serverHome/WEB-INF/";
opendir(CNF_DIR, $cnfDir) or die "could not open dir $cnfDir: $!";
my @sampleCnfs = grep { /\.sample/ && -f "$cnfDir/$_" } readdir(CNF_DIR);
foreach my $sampleCnf (@sampleCnfs) {
    chomp $sampleCnf;
    my $cnf = $1 if $sampleCnf =~ /(.+)\.sample$/;
    if (! -f "$cnfDir/$cnf") { 
	$cmd = "cp -f $cnfDir/$sampleCnf $cnfDir/$cnf";
	system("$cmd"); die ("ERROR: $!\nfailed running $cmd\n\n") if $?;
    }
}

# stage 1
#
print "generating webservice description from java ... \n";
$cmd = "java -Dwebservice.home=$serverHome -cp $cp org.apache.axis.wsdl.Java2WSDL " .
  "-o $deployTempDir/wdkProcessService.wsdl -l\"$serverURL/WdkProcessService\" " .
  "-n service.wdk.gusdb.org -p\"org.gusdb.wdk.service\" \"urn:service.wdk.gusdb.org\" " .
  "org.gusdb.wdk.service.WdkProcessService";
system($cmd); die ("ERROR: $!\nfailed running $cmd\n\n") if $?;

# stage 2
#
print("generating webservice client code and deployment descriptor ...\n");
$cmd = "java -cp $cp org.apache.axis.wsdl.WSDL2Java " .
  "-o $deployTempDir -d Session -c org.gusdb.wdk.service.WdkProcessServiceImp " .
  "-s $deployTempDir/wdkProcessService.wsdl";
system($cmd); die ("ERROR: $!\nfailed running $cmd\n\n") if $?;

system("mv $deployTempDir/org/gusdb/wdk/service/*.wsdd $deployTempDir/");
system("rm -f $deployTempDir/org/gusdb/wdk/service/WdkProcessServiceImp.java");

$cmd="javac -cp $cp -d $deployTempDir/classes $deployTempDir/org/gusdb/wdk/service/*.java";
system($cmd); die ("ERROR: $!\nfailed running $cmd\n\n") if $?;

my $pwd = `pwd`; chomp $pwd;
chdir "$deployTempDir/classes";
if (-f "WDK-ServiceStub.jar") { system("rm -rf WDK-ServiceStub.jar"); }
$cmd="jar -cf WDK-ServiceStub.jar org";
system($cmd); die ("ERROR: $!\nfailed running $cmd\n\n") if $?;
chdir $pwd;

system("cp $deployTempDir/classes/WDK-ServiceStub.jar $GUS_HOME/lib/java/");

$cmd="replace WdkProcessServiceImp WdkProcessService -- $deployTempDir/*.wsdd";
system($cmd); die ("ERROR: $!\nfailed running $cmd\n\n") if $?;

# stage 3
#
print("deploying jar files and config files on the server ...\n");
$cmd="cp -f $GUS_HOME/lib/java/*.jar $serverHome/WEB-INF/lib/";
system($cmd);
$cmd="cp -f $deployTempDir/*.wsdd $serverHome/WEB-INF/";
system($cmd);
system("rm -rf $deployTempDir");

# stage 4
#
# edit wdkService config and individual service configs
# and register service with server
#
print("\nNOTE: follow these steps to complete the WDK WebService deployment:\n");
print("1) edit wdkService-config.xml and config files for individual services under $serverHome/WEB-INF\n");
print("2) run \"wdkWebServiceRegister.sh $serverHome/WEB-INF/lib $serverURL $serverHome/WEB-INF/deploy.wsdd\"\n\n");
